<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="generator" content="Doxygen 1.9.4"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>DDC: Commented example: the heat equation</title>
	<script type="text/javascript" src="jquery.js"></script>
	<script type="text/javascript" src="dynsections.js"></script>
	<script type="text/javascript" src="navtreedata.js"></script>
	<script type="text/javascript" src="navtree.js"></script>
	<link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div>
<header id="titlearea">
	<div id="projectlogo"><a href="index.html"><img alt="Logo" src="logo.png"/></a></div>
	<h1 id="projectname">DDC&nbsp;<span id="projectnumber">0.0.0</span></h1>
	<h2 id="projectbrief">a <span class="acronym">d</span>iscrete <span class="acronym">d</span>omain <span class="acronym">c</span>omputation library</h2>
</header>
<nav id="tabs"><ul>
	<li><a href="index.html">About</a>
	<li><a href="first_steps.html">Commented example</a>
	<li><a href="annotated.html">API reference</a>
	<li id="gitlab-ribbon"><a rel="noopener" href="https://github.com/CExA-project/ddc" target="_blank">Contribute on Github</a></li>
</ul></nav>
<!-- Generated by Doxygen 1.9.4 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('first_steps.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Commented example: the heat equation </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md_first_steps"></a> In <a class="el" href="heat_equation.html">examples/heat_equation.cpp</a> is a DDC example implementing a forward finite-difference solver for the heat equation over a rectangle 2D domain with periodic boundary conditions.</p>
<p >As usual, the file starts with a few includes that will be used in the code.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;cmath&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iomanip&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;numeric&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;ddc/ddc.hpp&gt;</span></div>
</div><!-- fragment --><p >As you can see, to use DDC, we have to include <code>&lt;<a class="el" href="ddc_8hpp_source.html">ddc/ddc.hpp</a>&gt;</code></p>
<p >Then, we define the value of some parameters that would typically be read from some form of configuration file in a more realistic code.</p>
<div class="fragment"><div class="line">    <span class="comment">// Start of the domain of interest in the X dimension</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> x_start = -1.;</div>
<div class="line">    <span class="comment">// End of the domain of interest in the X dimension</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> x_end = 1.;</div>
<div class="line">    <span class="comment">// Number of discretization points in the X dimension</span></div>
<div class="line">    <span class="keywordtype">size_t</span> <span class="keyword">const</span> nb_x_points = 10;</div>
<div class="line">    <span class="comment">// Thermal diffusion coefficient</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> kx = .01;</div>
<div class="line">    <span class="comment">// Start of the domain of interest in the Y dimension</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> y_start = -1.;</div>
<div class="line">    <span class="comment">// End of the domain of interest in the Y dimension</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> y_end = 1.;</div>
<div class="line">    <span class="comment">// Number of discretization points in the Y dimension</span></div>
<div class="line">    <span class="keywordtype">size_t</span> <span class="keyword">const</span> nb_y_points = 100;</div>
<div class="line">    <span class="comment">// Thermal diffusion coefficient</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> ky = .002;</div>
<div class="line">    <span class="comment">// Simulated time at which to start simulation</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> start_time = 0.;</div>
<div class="line">    <span class="comment">// Simulated time to reach as target of the simulation</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> end_time = 10.;</div>
<div class="line">    <span class="comment">// Number of time-steps between outputs</span></div>
<div class="line">    ptrdiff_t <span class="keyword">const</span> t_output_period = 10;</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md2"></a>
Definition of the discretization</h1>
<p >Given the previous parameters, we will now define a 2D point discretization.</p>
<div class="image">
<img src="domains.png" alt=""/>
<div class="caption">
Domains</div></div>
    <h2><a class="anchor" id="autotoc_md3"></a>
Dimensions naming</h2>
<p >Before starting the <code>main</code> function, we start by defining types that we later use to name our dimensions.</p>
<p >First, we create <code>X</code>: a type that is declared but never defined to act as a tag identifying our first dimension.</p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="keyword">struct </span>X;</div>
</div><!-- fragment --><p >Then, we create <code>DDimX</code>, a type that will also act as a tag, but we define it to be a uniform discretization of <code>X</code>. Thus <code>DDimX</code> is an identifier for a discrete dimension.</p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="keyword">using </span>DDimX = <a class="code hl_class" href="classddc_1_1UniformPointSampling.html">ddc::UniformPointSampling&lt;X&gt;</a>;</div>
<div class="ttc" id="aclassddc_1_1UniformPointSampling_html"><div class="ttname"><a href="classddc_1_1UniformPointSampling.html">ddc::UniformPointSampling</a></div><div class="ttdoc">UniformPointSampling models a uniform discretization of the provided continuous dimension.</div><div class="ttdef"><b>Definition:</b> uniform_point_sampling.hpp:26</div></div>
</div><!-- fragment --><p >We do the same thing for the second dimension <code>Y</code>.</p>
<div class="fragment"><div class="line"><span class="comment">// Our second continuous dimension</span></div>
<div class="line"><span class="keyword">struct </span>Y;</div>
<div class="line"><span class="comment">// Its uniform discretization</span></div>
<div class="line"><span class="keyword">using </span>DDimY = <a class="code hl_class" href="classddc_1_1UniformPointSampling.html">ddc::UniformPointSampling&lt;Y&gt;</a>;</div>
</div><!-- fragment --><p >And once again, now for the time dimension.</p>
<div class="fragment"><div class="line"><span class="comment">// Our simulated time dimension</span></div>
<div class="line"><span class="keyword">struct </span>T;</div>
<div class="line"><span class="comment">// Its uniform discretization</span></div>
<div class="line"><span class="keyword">using </span>DDimT = <a class="code hl_class" href="classddc_1_1UniformPointSampling.html">ddc::UniformPointSampling&lt;T&gt;</a>;</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md4"></a>
Domains</h2>
<h3><a class="anchor" id="autotoc_md5"></a>
Dimension X</h3>
<p >Once the types are defined, we can start the <code>main</code> function where we will define our various domains.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)</div>
<div class="line">{</div>
<div class="line"><span class="preprocessor">#ifdef DDC_BUILD_PDI_WRAPPER</span></div>
<div class="line">    <span class="keyword">auto</span> pdi_conf = PC_parse_string(<span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">    PDI_init(pdi_conf);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line">    Kokkos::ScopeGuard <span class="keyword">const</span> kokkos_scope(argc, argv);</div>
<div class="line">    <a class="code hl_class" href="classddc_1_1ScopeGuard.html">ddc::ScopeGuard</a> <span class="keyword">const</span> ddc_scope(argc, argv);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// some parameters that would typically be read from some form of</span></div>
<div class="line">    <span class="comment">// configuration file in a more realistic code</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Start of the domain of interest in the X dimension</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> x_start = -1.;</div>
<div class="line">    <span class="comment">// End of the domain of interest in the X dimension</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> x_end = 1.;</div>
<div class="line">    <span class="comment">// Number of discretization points in the X dimension</span></div>
<div class="line">    <span class="keywordtype">size_t</span> <span class="keyword">const</span> nb_x_points = 10;</div>
<div class="line">    <span class="comment">// Thermal diffusion coefficient</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> kx = .01;</div>
<div class="line">    <span class="comment">// Start of the domain of interest in the Y dimension</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> y_start = -1.;</div>
<div class="line">    <span class="comment">// End of the domain of interest in the Y dimension</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> y_end = 1.;</div>
<div class="line">    <span class="comment">// Number of discretization points in the Y dimension</span></div>
<div class="line">    <span class="keywordtype">size_t</span> <span class="keyword">const</span> nb_y_points = 100;</div>
<div class="line">    <span class="comment">// Thermal diffusion coefficient</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> ky = .002;</div>
<div class="line">    <span class="comment">// Simulated time at which to start simulation</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> start_time = 0.;</div>
<div class="line">    <span class="comment">// Simulated time to reach as target of the simulation</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> end_time = 10.;</div>
<div class="line">    <span class="comment">// Number of time-steps between outputs</span></div>
<div class="line">    ptrdiff_t <span class="keyword">const</span> t_output_period = 10;</div>
<div class="line"> </div>
<div class="ttc" id="aclassddc_1_1ScopeGuard_html"><div class="ttname"><a href="classddc_1_1ScopeGuard.html">ddc::ScopeGuard</a></div><div class="ttdef"><b>Definition:</b> scope_guard.hpp:13</div></div>
</div><!-- fragment --><p >We start by defining <code>gwx</code>, the number of "ghost" points in the <code>X</code> dimension, those represented in dark grey in the figure on each side of the domain.</p>
<div class="fragment"><div class="line">    <span class="comment">// Number of ghost points to use on each side in X</span></div>
<div class="line">    <a class="code hl_class" href="classddc_1_1DiscreteVector.html">ddc::DiscreteVector&lt;DDimX&gt;</a> <span class="keyword">static</span> <span class="keyword">constexpr</span> gwx {1};</div>
<div class="ttc" id="aclassddc_1_1DiscreteVector_html"><div class="ttname"><a href="classddc_1_1DiscreteVector.html">ddc::DiscreteVector</a></div><div class="ttdoc">A DiscreteVector is a vector in the discrete dimension.</div><div class="ttdef"><b>Definition:</b> discrete_vector.hpp:252</div></div>
</div><!-- fragment --><p> This can be made <code>static constexpr</code> since here this is a compile-time constant. The type for this constant is <code>DiscreteVector&lt;DDimX&gt;</code> that represents a number of elements in the discretization of the <code>X</code> dimension.</p>
<p >Once done, we initialize the discretization of the <code>X</code> dimension. Its name has been specified before, but we now set its parameters with the <code>init_discretization</code> function.</p>
<div class="fragment"><div class="line">    <span class="comment">// Initialization of the global domain in X with gwx ghost points on</span></div>
<div class="line">    <span class="comment">// each side</span></div>
<div class="line">    <span class="keyword">auto</span> <span class="keyword">const</span> [x_domain, ghosted_x_domain, x_pre_ghost, x_post_ghost]</div>
<div class="line">            = <a class="code hl_function" href="namespaceddc.html#a70f12a43ed0afbc092f4e974b024db3d">ddc::init_discrete_space</a>(DDimX::init_ghosted(</div>
<div class="line">                    <a class="code hl_typedef" href="namespaceddc.html#ac18286f7d289865ee020284651f29bb1">ddc::Coordinate&lt;X&gt;</a>(x_start),</div>
<div class="line">                    <a class="code hl_typedef" href="namespaceddc.html#ac18286f7d289865ee020284651f29bb1">ddc::Coordinate&lt;X&gt;</a>(x_end),</div>
<div class="line">                    <a class="code hl_class" href="classddc_1_1DiscreteVector.html">ddc::DiscreteVector&lt;DDimX&gt;</a>(nb_x_points),</div>
<div class="line">                    gwx));</div>
<div class="ttc" id="anamespaceddc_html_a70f12a43ed0afbc092f4e974b024db3d"><div class="ttname"><a href="namespaceddc.html#a70f12a43ed0afbc092f4e974b024db3d">ddc::init_discrete_space</a></div><div class="ttdeci">void init_discrete_space(Args &amp;&amp;... args)</div><div class="ttdoc">Initialize (emplace) a global singleton discrete space.</div><div class="ttdef"><b>Definition:</b> discrete_space.hpp:148</div></div>
<div class="ttc" id="anamespaceddc_html_ac18286f7d289865ee020284651f29bb1"><div class="ttname"><a href="namespaceddc.html#ac18286f7d289865ee020284651f29bb1">ddc::Coordinate</a></div><div class="ttdeci">detail::TaggedVector&lt; CoordinateElement, CDims... &gt; Coordinate</div><div class="ttdoc">A Coordinate represents a coordinate in the continuous space.</div><div class="ttdef"><b>Definition:</b> coordinate.hpp:21</div></div>
</div><!-- fragment --><p> Depending on the way the function is called, its return type can differ. Here we use it with an inner call to <code>init_ghosted</code> and receive four 1D domains as a result. Their type is not specified because we use C++ <a href="https://en.cppreference.com/w/cpp/language/structured_binding">structured bindings</a>, but they are all of the same type: <code>DiscreteDomain&lt;DDimX&gt;</code> that represents a set of contiguous points in the discretization of <code>X</code>.</p>
<p ><a class="el" href="classddc_1_1UniformPointSampling.html#a598c738aabda8a778a2e3f0b4c68b94e">init_ghosted</a> takes as parameters the coordinate of the first and last discretized points, the number of discretized points in the domain and the number of additional points on each side of the domain. The fours <code>DiscreteDomain</code>s returned are:</p><ul>
<li><code>x_domain</code>: the main domain from the start (included) to end (included) but excluding "ghost" points.</li>
<li><code>ghosted_x_domain</code>: the domain including all "ghost" points.</li>
<li><code>x_pre_ghost</code>: the "ghost" points that come before the main domain.</li>
<li><code>x_post_ghost</code>: the "ghost" points that come after the main domain.</li>
</ul>
<p >The parameters of raw C++ types like <code>double</code> or <code>size_t</code> can not be used as-is since DDC enforces strong typing. Instead, for a coordinate in the <code>X</code> dimension, we use <code>Coordinate&lt;X&gt;</code> and &ndash;as already mentioned&ndash; for a number of elements in the discretization of <code>X</code>, we use <code>DiscreteVector&lt;DDimX&gt;</code>.</p>
<p >Once this is done, we define two additional domains.</p>
<div class="fragment"><div class="line">    <span class="comment">// our zone at the start of the domain that will be mirrored to the</span></div>
<div class="line">    <span class="comment">// ghost</span></div>
<div class="line">    <a class="code hl_class" href="classddc_1_1DiscreteDomain.html">ddc::DiscreteDomain&lt;DDimX&gt;</a> <span class="keyword">const</span></div>
<div class="line">            x_domain_begin(x_domain.front(), x_post_ghost.extents());</div>
<div class="line">    <span class="comment">// our zone at the end of the domain that will be mirrored to the</span></div>
<div class="line">    <span class="comment">// ghost</span></div>
<div class="line">    <a class="code hl_class" href="classddc_1_1DiscreteDomain.html">ddc::DiscreteDomain&lt;DDimX&gt;</a> <span class="keyword">const</span> x_domain_end(</div>
<div class="line">            x_domain.back() - x_pre_ghost.extents() + 1,</div>
<div class="line">            x_pre_ghost.extents());</div>
<div class="ttc" id="aclassddc_1_1DiscreteDomain_html"><div class="ttname"><a href="classddc_1_1DiscreteDomain.html">ddc::DiscreteDomain</a></div><div class="ttdef"><b>Definition:</b> discrete_domain.hpp:49</div></div>
</div><!-- fragment --><p ><code>x_domain_begin</code> is the sub-domain at the beginning of <code>x_domain</code> of the same shape as <code>x_post_ghost</code> that will be mirrored to it. Reciprocally for <code>x_domain_end</code> with <code>x_pre_ghost</code>.</p>
<p >The type of both sub-domains is <code>DiscreteDomain&lt;DDimX&gt;</code> even if only <code>DiscreteDomain</code> is specified, this relies on C++ <a href="https://en.cppreference.com/w/cpp/language/class_template_argument_deduction">class template argument deduction (CTAD)</a>. The first parameter given to the constructor is the first element of the domain, a <code>DiscreteElement&lt;DDimX&gt;</code>, the second parameter is a number of elements to include, a <code>DiscreteVector&lt;DDimX&gt;</code>.</p>
<p ><b>To summarize,</b> in this section, we have introduced the following types:</p><ul>
<li><code>Coordinate&lt;X&gt;</code> that represents a point in the continuous dimension <code>X</code>,</li>
<li><code>DiscreteElement&lt;DDimX&gt;</code> that represents one of the elements of <code>DDimX</code>, the discretization of <code>X</code>,</li>
<li><code>DiscreteVector&lt;DDimX&gt;</code> that represents a number of elements of <code>DDimX</code>,</li>
<li><code>DiscreteDomain&lt;DDimX&gt;</code> that represents an interval in <code>DDimX</code>, a set of contiguous elements of the discretization.</li>
</ul>
<h3><a class="anchor" id="autotoc_md6"></a>
Dimension Y</h3>
<p >The domains in the <code>Y</code> dimension are handled in a way very similar to the <code>X</code> dimension.</p>
<div class="fragment"><div class="line">    <span class="comment">// Number of ghost points to use on each side in Y</span></div>
<div class="line">    <a class="code hl_class" href="classddc_1_1DiscreteVector.html">ddc::DiscreteVector&lt;DDimY&gt;</a> <span class="keyword">static</span> <span class="keyword">constexpr</span> gwy {1};</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Initialization of the global domain in Y with gwy ghost points on</span></div>
<div class="line">    <span class="comment">// each side</span></div>
<div class="line">    <span class="keyword">auto</span> <span class="keyword">const</span> [y_domain, ghosted_y_domain, y_pre_ghost, y_post_ghost]</div>
<div class="line">            = <a class="code hl_function" href="namespaceddc.html#a70f12a43ed0afbc092f4e974b024db3d">ddc::init_discrete_space</a>(DDimY::init_ghosted(</div>
<div class="line">                    <a class="code hl_typedef" href="namespaceddc.html#ac18286f7d289865ee020284651f29bb1">ddc::Coordinate&lt;Y&gt;</a>(y_start),</div>
<div class="line">                    <a class="code hl_typedef" href="namespaceddc.html#ac18286f7d289865ee020284651f29bb1">ddc::Coordinate&lt;Y&gt;</a>(y_end),</div>
<div class="line">                    <a class="code hl_class" href="classddc_1_1DiscreteVector.html">ddc::DiscreteVector&lt;DDimY&gt;</a>(nb_y_points),</div>
<div class="line">                    gwy));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// our zone at the start of the domain that will be mirrored to the</span></div>
<div class="line">    <span class="comment">// ghost</span></div>
<div class="line">    <a class="code hl_class" href="classddc_1_1DiscreteDomain.html">ddc::DiscreteDomain&lt;DDimY&gt;</a> <span class="keyword">const</span></div>
<div class="line">            y_domain_begin(y_domain.front(), y_post_ghost.extents());</div>
<div class="line">    <span class="comment">// our zone at the end of the domain that will be mirrored to the</span></div>
<div class="line">    <span class="comment">// ghost</span></div>
<div class="line">    <a class="code hl_class" href="classddc_1_1DiscreteDomain.html">ddc::DiscreteDomain&lt;DDimY&gt;</a> <span class="keyword">const</span> y_domain_end(</div>
<div class="line">            y_domain.back() - y_pre_ghost.extents() + 1,</div>
<div class="line">            y_pre_ghost.extents());</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md7"></a>
Time dimension</h3>
<p >Then we handle the domains for the simulated time dimension.</p>
<div class="fragment"><div class="line">    <span class="comment">// max(1/dx^2)</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> invdx2_max = <a class="code hl_function" href="namespaceddc.html#a8093016bc9d65270b7b16ad4b7a1166e">ddc::transform_reduce</a>(</div>
<div class="line">            x_domain,</div>
<div class="line">            0.,</div>
<div class="line">            <a class="code hl_struct" href="structddc_1_1reducer_1_1max.html">ddc::reducer::max&lt;double&gt;</a>(),</div>
<div class="line">            [](<a class="code hl_class" href="classddc_1_1DiscreteElement.html">ddc::DiscreteElement&lt;DDimX&gt;</a> ix) {</div>
<div class="line">                <span class="keywordflow">return</span> 1.</div>
<div class="line">                       / (<a class="code hl_function" href="namespaceddc.html#a8f253df8e8ff614487617d65ed69d2f7">ddc::distance_at_left</a>(ix)</div>
<div class="line">                          * <a class="code hl_function" href="namespaceddc.html#ae4194d943599870a3027703892628bef">ddc::distance_at_right</a>(ix));</div>
<div class="line">            });</div>
<div class="line">    <span class="comment">// max(1/dy^2)</span></div>
<div class="line">    <span class="keywordtype">double</span> <span class="keyword">const</span> invdy2_max = <a class="code hl_function" href="namespaceddc.html#a8093016bc9d65270b7b16ad4b7a1166e">ddc::transform_reduce</a>(</div>
<div class="line">            y_domain,</div>
<div class="line">            0.,</div>
<div class="line">            <a class="code hl_struct" href="structddc_1_1reducer_1_1max.html">ddc::reducer::max&lt;double&gt;</a>(),</div>
<div class="line">            [](<a class="code hl_class" href="classddc_1_1DiscreteElement.html">ddc::DiscreteElement&lt;DDimY&gt;</a> iy) {</div>
<div class="line">                <span class="keywordflow">return</span> 1.</div>
<div class="line">                       / (<a class="code hl_function" href="namespaceddc.html#a8f253df8e8ff614487617d65ed69d2f7">ddc::distance_at_left</a>(iy)</div>
<div class="line">                          * <a class="code hl_function" href="namespaceddc.html#ae4194d943599870a3027703892628bef">ddc::distance_at_right</a>(iy));</div>
<div class="line">            });</div>
<div class="line">    <a class="code hl_typedef" href="namespaceddc.html#ac18286f7d289865ee020284651f29bb1">ddc::Coordinate&lt;T&gt;</a> <span class="keyword">const</span> max_dt {</div>
<div class="line">            .5 / (kx * invdx2_max + ky * invdy2_max)};</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// number of time intervals required to reach the end time</span></div>
<div class="line">    <span class="comment">// The + .2 is used to make sure it is rounded to the correct number of steps</span></div>
<div class="line">    <a class="code hl_class" href="classddc_1_1DiscreteVector.html">ddc::DiscreteVector&lt;DDimT&gt;</a> <span class="keyword">const</span> nb_time_steps {</div>
<div class="line">            std::ceil((end_time - start_time) / max_dt) + .2};</div>
<div class="line">    <span class="comment">// Initialization of the global domain in time:</span></div>
<div class="line">    <span class="comment">// - the number of discrete time-points is equal to the number of</span></div>
<div class="line">    <span class="comment">//   steps + 1</span></div>
<div class="line">    <span class="comment">// `init` takes required information to initialize the attributes of the dimension.</span></div>
<div class="line">    <a class="code hl_class" href="classddc_1_1DiscreteDomain.html">ddc::DiscreteDomain&lt;DDimT&gt;</a> <span class="keyword">const</span> time_domain</div>
<div class="line">            = <a class="code hl_function" href="namespaceddc.html#a70f12a43ed0afbc092f4e974b024db3d">ddc::init_discrete_space</a>(</div>
<div class="line">                    DDimT::</div>
<div class="line">                            init(<a class="code hl_typedef" href="namespaceddc.html#ac18286f7d289865ee020284651f29bb1">ddc::Coordinate&lt;T&gt;</a>(start_time),</div>
<div class="line">                                 <a class="code hl_typedef" href="namespaceddc.html#ac18286f7d289865ee020284651f29bb1">ddc::Coordinate&lt;T&gt;</a>(end_time),</div>
<div class="line">                                 nb_time_steps + 1));</div>
<div class="ttc" id="aclassddc_1_1DiscreteElement_html"><div class="ttname"><a href="classddc_1_1DiscreteElement.html">ddc::DiscreteElement</a></div><div class="ttdoc">A DiscreteElement identifies an element of the discrete dimension.</div><div class="ttdef"><b>Definition:</b> discrete_element.hpp:145</div></div>
<div class="ttc" id="anamespaceddc_html_a8093016bc9d65270b7b16ad4b7a1166e"><div class="ttname"><a href="namespaceddc.html#a8093016bc9d65270b7b16ad4b7a1166e">ddc::transform_reduce</a></div><div class="ttdeci">T transform_reduce(DiscreteDomain&lt; DDims... &gt; const &amp;domain, T neutral, BinaryReductionOp &amp;&amp;reduce, UnaryTransformOp &amp;&amp;transform) noexcept</div><div class="ttdoc">A reduction over a nD domain in serial.</div><div class="ttdef"><b>Definition:</b> transform_reduce.hpp:329</div></div>
<div class="ttc" id="anamespaceddc_html_a8f253df8e8ff614487617d65ed69d2f7"><div class="ttname"><a href="namespaceddc.html#a8f253df8e8ff614487617d65ed69d2f7">ddc::distance_at_left</a></div><div class="ttdeci">KOKKOS_FUNCTION Coordinate&lt; CDim &gt; distance_at_left(DiscreteElement&lt; NonUniformPointSampling&lt; CDim &gt; &gt; i)</div><div class="ttdef"><b>Definition:</b> non_uniform_point_sampling.hpp:145</div></div>
<div class="ttc" id="anamespaceddc_html_ae4194d943599870a3027703892628bef"><div class="ttname"><a href="namespaceddc.html#ae4194d943599870a3027703892628bef">ddc::distance_at_right</a></div><div class="ttdeci">KOKKOS_FUNCTION Coordinate&lt; CDim &gt; distance_at_right(DiscreteElement&lt; NonUniformPointSampling&lt; CDim &gt; &gt; i)</div><div class="ttdef"><b>Definition:</b> non_uniform_point_sampling.hpp:151</div></div>
<div class="ttc" id="astructddc_1_1reducer_1_1max_html"><div class="ttname"><a href="structddc_1_1reducer_1_1max.html">ddc::reducer::max</a></div><div class="ttdef"><b>Definition:</b> reducer.hpp:105</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md8"></a>
Data allocation</h1>
<p >We allocate two 2D Chunks along the X and Y dimensions which will be used to map temperature to the domains' points at t and t+dt. When constructing the Chunks one can give an optional string to label the memory allocations. This helps debugging and profiling applications using the Kokkos tools, see also <a href="https://github.com/kokkos/kokkos-tools">Kokkos Tools</a>.</p>
<div class="fragment"><div class="line">    <span class="comment">// Maps temperature into the full domain (including ghosts) twice:</span></div>
<div class="line">    <span class="comment">// - once for the last fully computed time-step</span></div>
<div class="line">    <a class="code hl_class" href="namespaceddc.html#classddc_1_1Chunk">ddc::Chunk</a> ghosted_last_temp(</div>
<div class="line">            <span class="stringliteral">&quot;ghosted_last_temp&quot;</span>,</div>
<div class="line">            <a class="code hl_class" href="classddc_1_1DiscreteDomain.html">ddc::DiscreteDomain</a>&lt;</div>
<div class="line">                    DDimX,</div>
<div class="line">                    DDimY&gt;(ghosted_x_domain, ghosted_y_domain),</div>
<div class="line">            <a class="code hl_class" href="classddc_1_1KokkosAllocator.html">ddc::DeviceAllocator&lt;double&gt;</a>());</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// - once for time-step being computed</span></div>
<div class="line">    <span class="comment">// The `DeviceAllocator` is responsible for allocating memory on the default memory space.</span></div>
<div class="line">    <a class="code hl_class" href="namespaceddc.html#classddc_1_1Chunk">ddc::Chunk</a> ghosted_next_temp(</div>
<div class="line">            <span class="stringliteral">&quot;ghosted_next_temp&quot;</span>,</div>
<div class="line">            <a class="code hl_class" href="classddc_1_1DiscreteDomain.html">ddc::DiscreteDomain</a>&lt;</div>
<div class="line">                    DDimX,</div>
<div class="line">                    DDimY&gt;(ghosted_x_domain, ghosted_y_domain),</div>
<div class="line">            <a class="code hl_class" href="classddc_1_1KokkosAllocator.html">ddc::DeviceAllocator&lt;double&gt;</a>());</div>
<div class="ttc" id="aclassddc_1_1KokkosAllocator_html"><div class="ttname"><a href="classddc_1_1KokkosAllocator.html">ddc::KokkosAllocator</a></div><div class="ttdef"><b>Definition:</b> kokkos_allocator.hpp:15</div></div>
<div class="ttc" id="anamespaceddc_html_classddc_1_1Chunk"><div class="ttname"><a href="namespaceddc.html#classddc_1_1Chunk">ddc::Chunk</a></div><div class="ttdef"><b>Definition:</b> chunk.hpp:18</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md9"></a>
Initial conditions</h1>
<div class="fragment"><div class="line">    <span class="comment">// The const qualifier makes it clear that ghosted_initial_temp always references</span></div>
<div class="line">    <span class="comment">// the same chunk, `ghosted_last_temp` in this case</span></div>
<div class="line">    <a class="code hl_class" href="namespaceddc.html#classddc_1_1ChunkSpan">ddc::ChunkSpan</a> <span class="keyword">const</span> ghosted_initial_temp</div>
<div class="line">            = ghosted_last_temp.span_view();</div>
<div class="line">    <span class="comment">// Initialize the temperature on the main domain</span></div>
<div class="line">    <a class="code hl_function" href="namespaceddc.html#a4d199106422f75f959c0d4260e10b3e0">ddc::parallel_for_each</a>(</div>
<div class="line">            <a class="code hl_class" href="classddc_1_1DiscreteDomain.html">ddc::DiscreteDomain&lt;DDimX, DDimY&gt;</a>(x_domain, y_domain),</div>
<div class="line">            KOKKOS_LAMBDA(<a class="code hl_class" href="classddc_1_1DiscreteElement.html">ddc::DiscreteElement&lt;DDimX, DDimY&gt;</a> <span class="keyword">const</span> ixy) {</div>
<div class="line">                <span class="keywordtype">double</span> <span class="keyword">const</span> x</div>
<div class="line">                        = <a class="code hl_function" href="namespaceddc.html#a6b058df8c02517deafeeb424e2f8803a">ddc::coordinate</a>(ddc::select&lt;DDimX&gt;(ixy));</div>
<div class="line">                <span class="keywordtype">double</span> <span class="keyword">const</span> y</div>
<div class="line">                        = <a class="code hl_function" href="namespaceddc.html#a6b058df8c02517deafeeb424e2f8803a">ddc::coordinate</a>(ddc::select&lt;DDimY&gt;(ixy));</div>
<div class="line">                ghosted_initial_temp(ixy)</div>
<div class="line">                        = 9.999 * ((x * x + y * y) &lt; 0.25);</div>
<div class="line">            });</div>
<div class="ttc" id="anamespaceddc_html_a4d199106422f75f959c0d4260e10b3e0"><div class="ttname"><a href="namespaceddc.html#a4d199106422f75f959c0d4260e10b3e0">ddc::parallel_for_each</a></div><div class="ttdeci">void parallel_for_each(ExecSpace const &amp;execution_space, DiscreteDomain&lt; DDims... &gt; const &amp;domain, Functor &amp;&amp;f) noexcept</div><div class="ttdoc">iterates over a nD domain using a given Kokkos execution space</div><div class="ttdef"><b>Definition:</b> parallel_for_each.hpp:143</div></div>
<div class="ttc" id="anamespaceddc_html_a6b058df8c02517deafeeb424e2f8803a"><div class="ttname"><a href="namespaceddc.html#a6b058df8c02517deafeeb424e2f8803a">ddc::coordinate</a></div><div class="ttdeci">KOKKOS_FUNCTION Coordinate&lt; typename DDim::continuous_dimension_type... &gt; coordinate(DiscreteElement&lt; DDim... &gt; const &amp;c)</div><div class="ttdef"><b>Definition:</b> coordinate_md.hpp:13</div></div>
<div class="ttc" id="anamespaceddc_html_classddc_1_1ChunkSpan"><div class="ttname"><a href="namespaceddc.html#classddc_1_1ChunkSpan">ddc::ChunkSpan</a></div><div class="ttdef"><b>Definition:</b> chunk_span.hpp:28</div></div>
</div><!-- fragment --><div class="fragment"><div class="line">    <span class="comment">// display the initial data</span></div>
<div class="line">    <a class="code hl_function" href="namespaceddc.html#a37d4f1dc7122e72c049517a90ff0b98b">ddc::parallel_deepcopy</a>(ghosted_temp, ghosted_last_temp);</div>
<div class="line">    display(<a class="code hl_function" href="namespaceddc.html#a6b058df8c02517deafeeb424e2f8803a">ddc::coordinate</a>(time_domain.<a class="code hl_function" href="classddc_1_1DiscreteDomain.html#a75660adbd6207e6dd4eec152cae420de">front</a>()),</div>
<div class="line">            ghosted_temp[x_domain][y_domain]);</div>
<div class="line">    <span class="comment">// time of the iteration where the last output happened</span></div>
<div class="line">    <a class="code hl_class" href="classddc_1_1DiscreteElement.html">ddc::DiscreteElement&lt;DDimT&gt;</a> last_output_iter = time_domain.<a class="code hl_function" href="classddc_1_1DiscreteDomain.html#a75660adbd6207e6dd4eec152cae420de">front</a>();</div>
<div class="ttc" id="aclassddc_1_1DiscreteDomain_html_a75660adbd6207e6dd4eec152cae420de"><div class="ttname"><a href="classddc_1_1DiscreteDomain.html#a75660adbd6207e6dd4eec152cae420de">ddc::DiscreteDomain::front</a></div><div class="ttdeci">KOKKOS_FUNCTION constexpr discrete_element_type front() const noexcept</div><div class="ttdef"><b>Definition:</b> discrete_domain.hpp:133</div></div>
<div class="ttc" id="anamespaceddc_html_a37d4f1dc7122e72c049517a90ff0b98b"><div class="ttname"><a href="namespaceddc.html#a37d4f1dc7122e72c049517a90ff0b98b">ddc::parallel_deepcopy</a></div><div class="ttdeci">auto parallel_deepcopy(ChunkDst &amp;&amp;dst, ChunkSrc &amp;&amp;src)</div><div class="ttdoc">Copy the content of a borrowed chunk into another.</div><div class="ttdef"><b>Definition:</b> parallel_deepcopy.hpp:19</div></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md10"></a>
Time loop</h1>
<div class="fragment"><div class="line">    <span class="keywordflow">for</span> (<span class="keyword">auto</span> <span class="keyword">const</span> iter :</div>
<div class="line">         time_domain.<a class="code hl_function" href="classddc_1_1DiscreteDomain.html#a95862b64fda54bb06c4adc8ddc0745db">remove_first</a>(<a class="code hl_class" href="classddc_1_1DiscreteVector.html">ddc::DiscreteVector&lt;DDimT&gt;</a>(1))) {</div>
<div class="ttc" id="aclassddc_1_1DiscreteDomain_html_a95862b64fda54bb06c4adc8ddc0745db"><div class="ttname"><a href="classddc_1_1DiscreteDomain.html#a95862b64fda54bb06c4adc8ddc0745db">ddc::DiscreteDomain::remove_first</a></div><div class="ttdeci">KOKKOS_FUNCTION constexpr DiscreteDomain remove_first(mlength_type n) const</div><div class="ttdef"><b>Definition:</b> discrete_domain.hpp:153</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md11"></a>
Periodic conditions</h2>
<div class="fragment"><div class="line">        <span class="comment">// Periodic boundary conditions</span></div>
<div class="line">        <a class="code hl_function" href="namespaceddc.html#a37d4f1dc7122e72c049517a90ff0b98b">ddc::parallel_deepcopy</a>(</div>
<div class="line">                ghosted_last_temp[x_pre_ghost][y_domain],</div>
<div class="line">                ghosted_last_temp[y_domain][x_domain_end]);</div>
<div class="line">        <a class="code hl_function" href="namespaceddc.html#a37d4f1dc7122e72c049517a90ff0b98b">ddc::parallel_deepcopy</a>(</div>
<div class="line">                ghosted_last_temp[y_domain][x_post_ghost],</div>
<div class="line">                ghosted_last_temp[y_domain][x_domain_begin]);</div>
<div class="line">        <a class="code hl_function" href="namespaceddc.html#a37d4f1dc7122e72c049517a90ff0b98b">ddc::parallel_deepcopy</a>(</div>
<div class="line">                ghosted_last_temp[x_domain][y_pre_ghost],</div>
<div class="line">                ghosted_last_temp[x_domain][y_domain_end]);</div>
<div class="line">        <a class="code hl_function" href="namespaceddc.html#a37d4f1dc7122e72c049517a90ff0b98b">ddc::parallel_deepcopy</a>(</div>
<div class="line">                ghosted_last_temp[x_domain][y_post_ghost],</div>
<div class="line">                ghosted_last_temp[x_domain][y_domain_begin]);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md12"></a>
Numerical scheme</h2>
<div class="fragment"><div class="line">        <span class="comment">// a span excluding ghosts of the temperature at the time-step we</span></div>
<div class="line">        <span class="comment">// will build</span></div>
<div class="line">        <a class="code hl_class" href="namespaceddc.html#classddc_1_1ChunkSpan">ddc::ChunkSpan</a> <span class="keyword">const</span> next_temp {</div>
<div class="line">                ghosted_next_temp[x_domain][y_domain]};</div>
<div class="line">        <span class="comment">// a read-only view of the temperature at the previous time-step</span></div>
<div class="line">        <span class="comment">// span_cview returns a read-only ChunkSpan</span></div>
<div class="line">        <a class="code hl_class" href="namespaceddc.html#classddc_1_1ChunkSpan">ddc::ChunkSpan</a> <span class="keyword">const</span> last_temp {ghosted_last_temp.span_cview()};</div>
</div><!-- fragment --><div class="fragment"><div class="line">        <span class="comment">// Stencil computation on the main domain</span></div>
<div class="line">        <a class="code hl_function" href="namespaceddc.html#a4d199106422f75f959c0d4260e10b3e0">ddc::parallel_for_each</a>(</div>
<div class="line">                next_temp.domain(),</div>
<div class="line">                KOKKOS_LAMBDA(</div>
<div class="line">                        <a class="code hl_class" href="classddc_1_1DiscreteElement.html">ddc::DiscreteElement&lt;DDimX, DDimY&gt;</a> <span class="keyword">const</span> ixy) {</div>
<div class="line">                    <a class="code hl_class" href="classddc_1_1DiscreteElement.html">ddc::DiscreteElement&lt;DDimX&gt;</a> <span class="keyword">const</span> ix</div>
<div class="line">                            = ddc::select&lt;DDimX&gt;(ixy);</div>
<div class="line">                    <a class="code hl_class" href="classddc_1_1DiscreteElement.html">ddc::DiscreteElement&lt;DDimY&gt;</a> <span class="keyword">const</span> iy</div>
<div class="line">                            = ddc::select&lt;DDimY&gt;(ixy);</div>
<div class="line">                    <span class="keywordtype">double</span> <span class="keyword">const</span> dx_l = <a class="code hl_function" href="namespaceddc.html#a8f253df8e8ff614487617d65ed69d2f7">ddc::distance_at_left</a>(ix);</div>
<div class="line">                    <span class="keywordtype">double</span> <span class="keyword">const</span> dx_r = <a class="code hl_function" href="namespaceddc.html#ae4194d943599870a3027703892628bef">ddc::distance_at_right</a>(ix);</div>
<div class="line">                    <span class="keywordtype">double</span> <span class="keyword">const</span> dx_m = 0.5 * (dx_l + dx_r);</div>
<div class="line">                    <span class="keywordtype">double</span> <span class="keyword">const</span> dy_l = <a class="code hl_function" href="namespaceddc.html#a8f253df8e8ff614487617d65ed69d2f7">ddc::distance_at_left</a>(iy);</div>
<div class="line">                    <span class="keywordtype">double</span> <span class="keyword">const</span> dy_r = <a class="code hl_function" href="namespaceddc.html#ae4194d943599870a3027703892628bef">ddc::distance_at_right</a>(iy);</div>
<div class="line">                    <span class="keywordtype">double</span> <span class="keyword">const</span> dy_m = 0.5 * (dy_l + dy_r);</div>
<div class="line">                    next_temp(ix, iy) = last_temp(ix, iy);</div>
<div class="line">                    next_temp(ix, iy)</div>
<div class="line">                            += kx * ddc::step&lt;DDimT&gt;()</div>
<div class="line">                               * (dx_l * last_temp(ix + 1, iy)</div>
<div class="line">                                  - 2.0 * dx_m * last_temp(ix, iy)</div>
<div class="line">                                  + dx_r * last_temp(ix - 1, iy))</div>
<div class="line">                               / (dx_l * dx_m * dx_r);</div>
<div class="line">                    next_temp(ix, iy)</div>
<div class="line">                            += ky * ddc::step&lt;DDimT&gt;()</div>
<div class="line">                               * (dy_l * last_temp(ix, iy + 1)</div>
<div class="line">                                  - 2.0 * dy_m * last_temp(ix, iy)</div>
<div class="line">                                  + dy_r * last_temp(ix, iy - 1))</div>
<div class="line">                               / (dy_l * dy_m * dy_r);</div>
<div class="line">                });</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md13"></a>
Output</h2>
<div class="fragment"><div class="line">        <span class="keywordflow">if</span> (iter - last_output_iter &gt;= t_output_period) {</div>
<div class="line">            last_output_iter = iter;</div>
<div class="line">            <a class="code hl_function" href="namespaceddc.html#a37d4f1dc7122e72c049517a90ff0b98b">ddc::parallel_deepcopy</a>(ghosted_temp, ghosted_last_temp);</div>
<div class="line">            display(<a class="code hl_function" href="namespaceddc.html#a6b058df8c02517deafeeb424e2f8803a">ddc::coordinate</a>(iter),</div>
<div class="line">                    ghosted_temp[x_domain][y_domain]);</div>
<div class="line">        }</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md14"></a>
Final swap</h2>
<div class="fragment"><div class="line">        <span class="comment">// Swap our two buffers</span></div>
<div class="line">        std::swap(ghosted_last_temp, ghosted_next_temp);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md15"></a>
Final output</h1>
<div class="fragment"><div class="line">    <span class="keywordflow">if</span> (last_output_iter &lt; time_domain.<a class="code hl_function" href="classddc_1_1DiscreteDomain.html#abc808a930eda098e573917e26c5140b3">back</a>()) {</div>
<div class="line">        <a class="code hl_function" href="namespaceddc.html#a37d4f1dc7122e72c049517a90ff0b98b">ddc::parallel_deepcopy</a>(ghosted_temp, ghosted_last_temp);</div>
<div class="line">        display(<a class="code hl_function" href="namespaceddc.html#a6b058df8c02517deafeeb424e2f8803a">ddc::coordinate</a>(time_domain.<a class="code hl_function" href="classddc_1_1DiscreteDomain.html#abc808a930eda098e573917e26c5140b3">back</a>()),</div>
<div class="line">                ghosted_temp[x_domain][y_domain]);</div>
<div class="line">    }</div>
<div class="ttc" id="aclassddc_1_1DiscreteDomain_html_abc808a930eda098e573917e26c5140b3"><div class="ttname"><a href="classddc_1_1DiscreteDomain.html#abc808a930eda098e573917e26c5140b3">ddc::DiscreteDomain::back</a></div><div class="ttdeci">KOKKOS_FUNCTION constexpr discrete_element_type back() const noexcept</div><div class="ttdef"><b>Definition:</b> discrete_domain.hpp:138</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
</body>
</html>
